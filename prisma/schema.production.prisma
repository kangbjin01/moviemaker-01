// This is the PRODUCTION Prisma schema file (PostgreSQL)
// For local development, use schema.prisma (SQLite)
// 
// To deploy to production:
// 1. Copy this file to schema.prisma before building
// 2. Or use: cp prisma/schema.production.prisma prisma/schema.prisma

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider  = "postgresql"
    url       = env("DATABASE_URL")
}

enum Role {
    USER
    SUPER_ADMIN
}

// Necessary for Next auth
model Account {
    id                String  @id @default(cuid())
    userId            String
    type              String
    provider          String
    providerAccountId String
    refresh_token     String? @db.Text
    access_token      String? @db.Text
    expires_at        Int?
    token_type        String?
    scope             String?
    id_token          String? @db.Text
    session_state     String?
    user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([provider, providerAccountId])
}

model Session {
    id           String   @id @default(cuid())
    sessionToken String   @unique
    userId       String
    expires      DateTime
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
    id                       String                     @id @default(cuid())
    name                     String?
    email                    String?                    @unique
    emailVerified            DateTime?
    image                    String?
    password                 String?
    role                     Role                       @default(USER)
    accounts                 Account[]
    sessions                 Session[]
    LemonSqueezySubscription LemonSqueezySubscription[]

    plan         Plan?          @relation(fields: [planId], references: [id])
    planId       Int?
    FeatureUsage FeatureUsage[]

    createdAt       DateTime          @default(now())
    updatedAt       DateTime          @default(now()) @updatedAt
    oneTimePurchase OneTimePurchase[]
    
    // 프로젝트 관계
    projects        Project[]
}

model LemonSqueezyWebhookEvent {
    id              Int      @id @default(autoincrement())
    eventName       String
    processed       Boolean  @default(false)
    body            Json
    createdAt       DateTime @default(now())
    processingError String?
}

model LemonSqueezySubscription {
    id                                  Int       @id @default(autoincrement())
    lemonSqueezyId                      String    @unique
    orderId                             Int
    name                                String
    email                               String
    status                              String
    renewsAt                            DateTime?
    endsAt                              DateTime?
    trialEndsAt                         DateTime?
    isUsageBased                        Boolean   @default(false)
    isPaused                            Boolean   @default(false)
    customerId                          String
    variantId                           String
    customerPortalUrl                   String?
    updatePaymentMethodUrl              String?
    customerPortalUpdateSubscriptionUrl String?

    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model OneTimePurchase {
    id             Int    @id @default(autoincrement())
    lemonSqueezyId String @unique
    orderId        Int
    name           String
    email          String
    status         String
    customerId     String
    variantId      String

    userId String
    user   User   @relation(fields: [userId], references: [id])
}

model Plan {
    id                    Int    @id @default(autoincrement())
    lemonSqueezyVariantId String @unique
    name                  String

    buttonClicks Int?
    aiCalls      Int?
    fileUploads  Int?

    users User[]
}

model FeatureUsage {
    id           String @id @default(cuid())
    userId       String
    buttonClicks Int    @default(0)
    aiCalls      Int    @default(0)
    fileUploads  Int    @default(0)

    date DateTime @default(now())
    user User     @relation(fields: [userId], references: [id])

    @@unique([userId, date])
}

model VerificationToken {
    identifier String
    token      String   @unique
    expires    DateTime

    @@unique([identifier, token])
}

// ==========================================
// 프로젝트 (Project) 모델
// ==========================================

model Project {
    id            String   @id @default(cuid())
    
    userId        String?
    user          User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
    
    title         String
    type          String?
    productionCo  String?
    
    director      String?
    producer      String?
    adName        String?
    
    startDate     DateTime?
    endDate       DateTime?
    
    status        String           @default("PREP")
    
    callSheets    DailyCallSheet[]
    projectStaff  ProjectStaff[]
    projectCast   ProjectCast[]
    
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt
}

// ==========================================
// 프로젝트 스태프 (Project Staff) 모델
// ==========================================

model ProjectStaff {
    id            String   @id @default(cuid())
    
    projectId     String
    project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
    
    name          String
    position      String
    contact       String?
    
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt
}

// ==========================================
// 프로젝트 캐스트 (Project Cast) 모델
// ==========================================

model ProjectCast {
    id            String   @id @default(cuid())
    
    projectId     String
    project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
    
    actorName     String
    role          String
    contact       String?
    
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt
}

// ==========================================
// 일일촬영계획표 (Daily Call Sheet) 모델
// ==========================================

model DailyCallSheet {
    id            String   @id @default(cuid())
    
    projectId     String
    project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
    
    episode       String?
    shootingDay   Int
    date          DateTime
    
    weather       String?
    tempMin       String?
    tempMax       String?
    precipitation String?
    sunrise       String?
    sunset        String?
    
    director      String?
    producer      String?
    adName        String?
    
    location      String?
    address       String?
    meetingPlace  String?
    parkingInfo   String?
    
    emergencyContact String?
    
    crewCallTime     String?
    talentCallTime   String?
    
    generalNotes  String?  @db.Text
    
    detailDirection     String?  @db.Text
    detailAssistDir     String?  @db.Text
    detailLighting      String?  @db.Text
    detailWardrobe      String?  @db.Text
    detailSound         String?  @db.Text
    detailProduction    String?  @db.Text
    detailArt           String?  @db.Text
    detailCamera        String?  @db.Text
    detailEtc           String?  @db.Text
    
    scenes        Scene[]
    schedules     Schedule[]
    staffList     Staff[]
    castMembers   CastMember[]
    
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt
}

model Scene {
    id            String   @id @default(cuid())
    
    callSheetId   String
    callSheet     DailyCallSheet @relation(fields: [callSheetId], references: [id], onDelete: Cascade)
    
    order         Int
    
    sceneNumber   String
    description   String?  @db.Text
    
    locationType  String?
    locationName  String?
    dayNight      String?
    
    pages         String?
    
    estimatedTime Int?
    startTime     String?
    endTime       String?
    
    cast          String?
    extras        Int?
    
    props         String?
    wardrobe      String?
    makeup        String?
    specialEquip  String?
    
    notes         String?  @db.Text
    
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt
}

// ==========================================
// 전체 일정 (Schedule) 모델
// ==========================================

model Schedule {
    id            String   @id @default(cuid())
    
    callSheetId   String
    callSheet     DailyCallSheet @relation(fields: [callSheetId], references: [id], onDelete: Cascade)
    
    order         Int
    
    time          String?
    content       String?
    
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt
}

// ==========================================
// 스태프 (Staff) 모델
// ==========================================

model Staff {
    id            String   @id @default(cuid())
    
    callSheetId   String
    callSheet     DailyCallSheet @relation(fields: [callSheetId], references: [id], onDelete: Cascade)
    
    order         Int
    
    position      String?
    name          String?
    contact       String?
    
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt
}

// ==========================================
// 캐스트 (CastMember) 모델
// ==========================================

model CastMember {
    id            String   @id @default(cuid())
    
    callSheetId   String
    callSheet     DailyCallSheet @relation(fields: [callSheetId], references: [id], onDelete: Cascade)
    
    order         Int
    
    role          String?
    actorName     String?
    callTime      String?
    callLocation  String?
    scenes        String?
    preparation   String?
    contact       String?
    
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt
}
