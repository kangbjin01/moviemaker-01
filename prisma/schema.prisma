// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "sqlite"
    url      = env("DATABASE_URL")
}

// Role is stored as String for SQLite compatibility
// Values: "USER" | "SUPER_ADMIN"

// Necessary for Next auth
model Account {
    id                String  @id @default(cuid())
    userId            String
    type              String
    provider          String
    providerAccountId String
    refresh_token     String? // @db.Text
    access_token      String? // @db.Text
    expires_at        Int?
    token_type        String?
    scope             String?
    id_token          String? // @db.Text
    session_state     String?
    user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([provider, providerAccountId])
}

model Session {
    id           String   @id @default(cuid())
    sessionToken String   @unique
    userId       String
    expires      DateTime
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
    id                       String                     @id @default(cuid())
    name                     String?
    email                    String?                    @unique
    emailVerified            DateTime?
    image                    String?
    role                     String                     @default("USER")
    accounts                 Account[]
    sessions                 Session[]
    LemonSqueezySubscription LemonSqueezySubscription[]

    plan         Plan?          @relation(fields: [planId], references: [id])
    planId       Int?
    FeatureUsage FeatureUsage[]

    createdAt       DateTime          @default(now())
    updatedAt       DateTime          @default(now()) @updatedAt
    oneTimePurchase OneTimePurchase[]
    
    // 프로젝트 관계
    projects        Project[]
}

model LemonSqueezyWebhookEvent {
    id              Int      @id @default(autoincrement())
    eventName       String
    processed       Boolean  @default(false)
    body            String
    createdAt       DateTime @default(now())
    processingError String?
}

model LemonSqueezySubscription {
    id                                  Int       @id @default(autoincrement())
    lemonSqueezyId                      String    @unique
    orderId                             Int
    name                                String
    email                               String
    status                              String
    renewsAt                            DateTime?
    endsAt                              DateTime?
    trialEndsAt                         DateTime?
    isUsageBased                        Boolean   @default(false)
    isPaused                            Boolean   @default(false)
    customerId                          String
    variantId                           String
    customerPortalUrl                   String?
    updatePaymentMethodUrl              String?
    customerPortalUpdateSubscriptionUrl String?

    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model OneTimePurchase {
    id             Int    @id @default(autoincrement())
    lemonSqueezyId String @unique
    orderId        Int
    name           String
    email          String
    status         String
    customerId     String
    variantId      String

    userId String
    user   User   @relation(fields: [userId], references: [id])
}

model Plan {
    id                    Int    @id @default(autoincrement())
    lemonSqueezyVariantId String @unique
    name                  String

    // Paywalled features, this is the number of credits the user can spend on each feature per month

    buttonClicks Int?
    aiCalls      Int?
    fileUploads  Int?

    users User[] // This establishes the one-to-many relationship
}

model FeatureUsage {
    id           String @id @default(cuid())
    userId       String
    buttonClicks Int    @default(0)
    aiCalls      Int    @default(0)
    fileUploads  Int    @default(0)

    // Add more features as needed
    date DateTime @default(now())
    user User     @relation(fields: [userId], references: [id])

    @@unique([userId, date])
}

model VerificationToken {
    identifier String
    token      String   @unique
    expires    DateTime

    @@unique([identifier, token])
}

// ==========================================
// 프로젝트 (Project) 모델
// ==========================================

model Project {
    id            String   @id @default(cuid())
    
    // 소유자 (선택적 - MVP에서는 인증 없이 사용 가능)
    userId        String?
    user          User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
    
    // 기본 정보
    title         String           // 작품명
    type          String?          // 작품 유형 (영화/드라마/웹드라마/광고 등)
    productionCo  String?          // 제작사
    
    // 제작진 정보 (프로젝트 기본값)
    director      String?          // 감독
    producer      String?          // 프로듀서
    adName        String?          // 조연출
    
    // 일정
    startDate     DateTime?        // 촬영 시작 예정일
    endDate       DateTime?        // 촬영 종료 예정일
    
    // 상태
    status        String           @default("PREP") // PREP/SHOOTING/POST/COMPLETED
    
    // 일촬표 목록
    callSheets    DailyCallSheet[]
    
    // 프로젝트 스태프 풀
    projectStaff  ProjectStaff[]
    
    // 프로젝트 캐스트(배우) 풀
    projectCast   ProjectCast[]
    
    // 타임스탬프
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt
}

// ==========================================
// 프로젝트 스태프 (Project Staff) 모델
// 프로젝트 단위로 관리되는 스태프 풀
// ==========================================

model ProjectStaff {
    id            String   @id @default(cuid())
    
    // 프로젝트 참조
    projectId     String
    project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
    
    // 스태프 정보
    name          String           // 이름
    position      String           // 직책/역할
    contact       String?          // 연락처
    
    // 타임스탬프
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt
}

// ==========================================
// 프로젝트 캐스트 (Project Cast) 모델
// 프로젝트 단위로 관리되는 배우 풀
// ==========================================

model ProjectCast {
    id            String   @id @default(cuid())
    
    // 프로젝트 참조
    projectId     String
    project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
    
    // 배우 정보
    actorName     String           // 연기자 이름
    role          String           // 배역
    contact       String?          // 연락처
    
    // 타임스탬프
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt
}

// ==========================================
// 일일촬영계획표 (Daily Call Sheet) 모델
// ==========================================

model DailyCallSheet {
    id            String   @id @default(cuid())
    
    // 프로젝트 참조
    projectId     String
    project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
    
    // 기본 정보
    episode       String?          // 회차/에피소드
    shootingDay   Int              // 촬영 일차 (Day 1, Day 2...)
    date          DateTime         // 촬영 날짜
    
    // 날씨/시간 정보
    weather       String?          // 날씨 예보
    sunrise       String?          // 일출 시간
    sunset        String?          // 일몰 시간
    
    // 제작진 정보
    director      String?          // 감독
    producer      String?          // 프로듀서/제작
    adName        String?          // 조연출 (Assistant Director)
    
    // 장소 정보
    location      String?          // 촬영 장소명
    address       String?          // 주소
    meetingPlace  String?          // 집합장소
    parkingInfo   String?          // 주차 정보
    
    // 연락처
    emergencyContact String?       // 비상 연락처
    
    // 일반 콜타임
    crewCallTime     String?       // 스태프 콜타임
    talentCallTime   String?       // 배우 콜타임
    
    // 메모
    generalNotes  String?          // 전체 공지사항
    
    // 세부 진행 (텍스트 필드)
    detailDirection     String?   // 연출
    detailAssistDir     String?   // 조연출
    detailLighting      String?   // 조명
    detailWardrobe      String?   // 의상
    detailSound         String?   // 음향
    detailProduction    String?   // 제작
    detailArt           String?   // 미술
    detailCamera        String?   // 촬영/관련 장비
    detailEtc           String?   // 기타
    
    // 씬 목록
    scenes        Scene[]
    
    // 전체 일정 목록
    schedules     Schedule[]
    
    // 스태프 목록
    staffList     Staff[]
    
    // 캐스트 목록
    castMembers   CastMember[]
    
    // 타임스탬프
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt
}

model Scene {
    id            String   @id @default(cuid())
    
    // 일촬표 참조
    callSheetId   String
    callSheet     DailyCallSheet @relation(fields: [callSheetId], references: [id], onDelete: Cascade)
    
    // 촬영 순서
    order         Int              // 촬영 순서 (드래그앤드롭으로 변경 가능)
    
    // 씬 정보
    sceneNumber   String           // 씬 번호 (예: "S#12", "1-3")
    description   String?          // 씬 설명/내용
    
    // 장소/시간대
    locationType  String?          // INT/EXT (실내/실외)
    locationName  String?          // 장소명 (예: "철수의 방")
    dayNight      String?          // D/N/새벽/해질녘 등
    
    // 분량
    pages         String?          // 페이지 수 (예: "2 3/8")
    
    // 시간
    estimatedTime Int?             // 예상 소요시간 (분)
    startTime     String?          // 시작 예정 시간
    endTime       String?          // 종료 예정 시간
    
    // 출연진 (쉼표로 구분된 문자열로 저장 - SQLite 호환)
    cast          String?          // 출연 배우 목록
    extras        Int?             // 보조출연 인원 수
    
    // 소품/특수 요구사항
    props         String?          // 소품 목록
    wardrobe      String?          // 의상 정보
    makeup        String?          // 분장 정보
    specialEquip  String?          // 특수 장비
    
    // 비고
    notes         String?          // 추가 메모
    
    // 타임스탬프
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt
}

// ==========================================
// 전체 일정 (Schedule) 모델
// ==========================================

model Schedule {
    id            String   @id @default(cuid())
    
    // 일촬표 참조
    callSheetId   String
    callSheet     DailyCallSheet @relation(fields: [callSheetId], references: [id], onDelete: Cascade)
    
    // 순서
    order         Int              // 정렬 순서
    
    // 일정 정보
    time          String?          // 시간 (예: "06:30")
    content       String?          // 내용
    
    // 타임스탬프
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt
}

// ==========================================
// 스태프 (Staff) 모델
// ==========================================

model Staff {
    id            String   @id @default(cuid())
    
    // 일촬표 참조
    callSheetId   String
    callSheet     DailyCallSheet @relation(fields: [callSheetId], references: [id], onDelete: Cascade)
    
    // 순서
    order         Int              // 정렬 순서
    
    // 스태프 정보
    position      String?          // 직책
    name          String?          // 이름
    contact       String?          // 연락처
    
    // 타임스탬프
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt
}

// ==========================================
// 캐스트 (CastMember) 모델
// ==========================================

model CastMember {
    id            String   @id @default(cuid())
    
    // 일촬표 참조
    callSheetId   String
    callSheet     DailyCallSheet @relation(fields: [callSheetId], references: [id], onDelete: Cascade)
    
    // 순서
    order         Int              // 정렬 순서
    
    // 캐스트 정보
    role          String?          // 배역
    actorName     String?          // 연기자
    callTime      String?          // 집합시간
    callLocation  String?          // 집합 위치
    scenes        String?          // 등장면
    preparation   String?          // 배우 준비 의상/소품
    contact       String?          // 연락처
    
    // 타임스탬프
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt
}
